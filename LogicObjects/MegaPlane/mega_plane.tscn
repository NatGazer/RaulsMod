[gd_scene load_steps=16 format=3 uid="uid://divon04875xo7"]

[ext_resource type="ArrayMesh" uid="uid://dsmavqaxun11t" path="res://LogicObjects/MegaPlane/MegaPlane_Cube_002.res" id="1_5ag8h"]

[sub_resource type="GDScript" id="GDScript_mvi26"]
resource_name = "MegaPlane"
script/source = "extends Node3D

const sensed_radius : float = 30

func activate() -> void:
	%PilotPlane.pilot_mode = true
	Global.Camera.set_orbital_parent(%CamHolder, 11)

func deactivate() -> void:
	%PilotPlane.pilot_mode = false

func distance_to_player() -> float:
	return %Plane.global_position.distance_to(Global.Player.position)
"

[sub_resource type="GDScript" id="GDScript_5ag8h"]
script/source = "extends Node3D

var pilot_mode : bool = false
@onready var rb : RigidBody3D = %Plane

var Force : float = 4E8
var Torque : float = 2E7

func _process(delta: float) -> void:
	var velocity = rb.linear_velocity
	
	# --- Local Velocity (relative to plane) ---
	var local_velocity : Vector3 = rb.basis.inverse() * velocity
	var forward_speed : float = -local_velocity.z
	var side_slip : float = local_velocity.x
	var vertical_slip : float = local_velocity.y

	if velocity.length() > 0.5:
		# --- Sliding Resistance (Yaw and Pitch Damping) ---
		var yaw_damp = 0.001     # Side slip (yaw correction)
		var pitch_damp = 0.02   # Vertical slip (pitch correction)
		var tail_offset = 25.0  # How far back the tail is

		# Pitch resistance (applied at center)
		var pitch_force_local : Vector3 = Vector3(0, -vertical_slip, 0) * abs(forward_speed) * pitch_damp * Force * delta
		rb.apply_central_force(rb.basis * pitch_force_local)

		# Yaw resistance (applied at tail to induce torque)
		var yaw_force_local = Vector3(-side_slip, 0, 0) * abs(forward_speed) * yaw_damp * Force * delta
		var yaw_force_world : Vector3 = rb.basis * yaw_force_local
		var tail_world_position : Vector3 = rb.basis.z * tail_offset
		rb.apply_force(yaw_force_world, tail_world_position)
	
	if not pilot_mode:
		return
	
	# --- Power Control ---
	var power_direction : int = -int(Input.is_key_pressed(KEY_SHIFT)) + int(Input.is_key_pressed(KEY_CTRL))
	rb.apply_central_force(rb.basis * Vector3(0, 0, power_direction * Force * delta))

	# --- Directional Control (Torque inputs) ---
	var x_torque : int = -int(Input.is_key_pressed(KEY_W)) + int(Input.is_key_pressed(KEY_S))
	var y_torque : int = -int(Input.is_key_pressed(KEY_E)) + int(Input.is_key_pressed(KEY_Q))
	var z_torque : int = -int(Input.is_key_pressed(KEY_D)) + int(Input.is_key_pressed(KEY_A))

	var control_torque = rb.basis * Vector3(x_torque, y_torque, z_torque*0.1) * forward_speed * Torque * delta
	rb.apply_torque(control_torque)


	
	
"

[sub_resource type="PhysicsMaterial" id="PhysicsMaterial_5ag8h"]
friction = 0.1

[sub_resource type="FastNoiseLite" id="FastNoiseLite_rkwwl"]
noise_type = 2
frequency = 0.0329
fractal_type = 0

[sub_resource type="NoiseTexture2D" id="NoiseTexture2D_h10xb"]
width = 1024
height = 1024
in_3d_space = true
seamless = true
as_normal_map = true
bump_strength = 2.0
noise = SubResource("FastNoiseLite_rkwwl")

[sub_resource type="StandardMaterial3D" id="StandardMaterial3D_h10xb"]
albedo_color = Color(0.371938, 0.890625, 0.830679, 1)
metallic = 1.0
roughness = 0.14
normal_enabled = true
normal_texture = SubResource("NoiseTexture2D_h10xb")

[sub_resource type="ConvexPolygonShape3D" id="ConvexPolygonShape3D_5ag8h"]
points = PackedVector3Array(-3.11807, 0.878024, -0.994114, -0.779518, 1.85215, 0.7598, -1.16897, 0.0982396, 0.7598, 0.847784, 1.73832, -1.42698, 1.75376, 0.682992, -1.57875, 1.16897, 0.0982396, 0.7598, 0.779518, 1.85215, 0.7598, 2.92273, 1.2674, -1.57875, -1.75376, 0.682992, -1.57875, -2.92273, 1.2674, -1.57875, -0.974244, 0.0982396, 0.175162, -2.92273, 1.07237, -0.409476, -0.847825, 1.73836, -1.42703, 2.92273, 1.07237, -0.409476, 2.92273, 0.682992, -0.799082, 0.974244, 0.0982396, 0.175162, -1.3637, 0.878024, 0.7598, 1.3637, 0.878024, 0.7598, -2.92273, 0.682992, -0.799082, -2.92273, 1.2674, -0.60405, 2.92273, 1.2674, -0.60405, -2.92273, 0.682992, -0.409476, 2.92273, 0.682992, -0.409476, -2.72801, 0.878024, -1.57875, 2.72801, 0.878024, -1.57875, 3.11807, 0.878024, -0.994114, -1.3637, 0.293272, 0.7598, 1.3637, 0.293272, 0.7598, -3.11807, 1.07237, -0.60405, 3.11807, 1.07237, -0.60405, 2.72801, 0.682992, -0.994114, -2.72801, 0.682992, -0.994114)

[sub_resource type="ConvexPolygonShape3D" id="ConvexPolygonShape3D_phj5u"]
points = PackedVector3Array(-1.55938, 0.487941, 0.7598, -6.04086, 0.293176, 3.48765, -0.584638, -0.0966397, 4.46243, -0.584638, 0.682801, 4.65739, -0.584638, -0.0966397, 0.954756, -0.779918, 0.877757, 0.7598, -5.45613, 0.877757, 3.09812, -6.04086, 0.098316, 4.26748, -6.23614, 0.487941, 4.26748, -2.33884, 0.877757, 2.90279, -0.974645, -0.0966397, 0.954756, -5.45613, 0.877757, 3.48765, -0.779918, 0.098316, 4.65739, -1.55938, 0.877757, 0.7598, -1.55938, -0.0966397, 3.68299, -1.16937, 0.098316, 0.7598, -5.65141, 0.682801, 4.07252, -5.84613, 0.682801, 3.29308, -0.584638, 0.098316, 0.7598, -0.779918, 0.877757, 1.53962, -5.84613, 0.098316, 3.87756, -1.55938, -0.0966397, 2.31906, -6.23614, 0.293176, 3.68299, -6.04086, 0.682801, 3.48765, -0.779918, 0.682801, 4.65739, -0.584638, 0.682801, 3.87756, -5.84613, 0.487941, 3.29308, -1.16937, -0.0966397, 4.26748, -4.87139, 0.877757, 2.70859, -6.04086, 0.682801, 3.87756, -6.04086, 0.098316, 4.07252, -0.779918, -0.0966397, 4.46243)

[sub_resource type="ConvexPolygonShape3D" id="ConvexPolygonShape3D_lofhx"]
points = PackedVector3Array(2.72831, 1.26763, -1.57875, -0.779289, 1.07279, -5.47634, -0.974244, 0.877852, -5.08643, -2.72831, 1.26763, -1.57875, 0.974244, 1.85215, -4.11203, 2.72831, 0.877852, -1.77371, -0.974244, 1.85215, -1.57875, -0.974244, 1.65712, -5.28138, -2.72831, 0.877852, -1.57875, 0.779289, 1.07279, -5.47634, 0.974244, 1.65712, -5.28138, 0.974244, 1.85215, -1.57875, -0.974244, 1.85215, -4.11203, 1.36416, 0.877852, -4.69614, -2.72831, 1.26763, -2.16362, 2.72831, 1.26763, -2.16362, -1.36416, 0.877852, -4.69614, -0.779289, 1.65712, -5.47634, 2.72831, 0.877852, -1.57875, 1.36416, 1.26763, -4.89147, -1.36416, 1.26763, -4.89147, 0.779289, 1.65712, -5.47634, -2.72831, 1.07279, -2.16362, 2.72831, 1.07279, -2.16362, 0.974244, 0.877852, -5.08643, -2.72831, 0.877852, -1.77371, 1.94849, 0.877852, -3.52755, -1.94849, 0.877852, -3.52755)

[sub_resource type="ConvexPolygonShape3D" id="ConvexPolygonShape3D_3k2d7"]
points = PackedVector3Array(5.45578, 0.877757, 3.4879, 0.780051, 0.098316, 0.7598, 0.780051, -0.0966397, 0.954794, 0.780051, 0.487941, 4.46251, 6.04118, 0.098316, 4.26715, 0.780051, 0.877757, 0.7598, 0.780051, -0.0966397, 4.26715, 5.84569, 0.487941, 3.29254, 0.780051, 0.682801, 4.26715, 1.55987, 0.877757, 0.7598, 6.23614, 0.487941, 4.26715, 2.9235, 0.877757, 3.29254, 1.16996, 0.098316, 0.7598, 6.04118, 0.293176, 3.4879, 5.45578, 0.877757, 3.09828, 1.55987, -0.0966397, 2.31903, 1.55987, 0.487941, 0.7598, 0.975007, 0.098316, 4.46251, 5.65074, 0.682801, 4.07252, 0.780051, 0.877757, 1.53941, 0.975007, -0.0966397, 0.954794, 5.84569, 0.098316, 3.87753, 1.55987, -0.0966397, 3.68289, 6.04118, 0.682801, 3.4879, 6.23614, 0.293176, 3.68289, 3.31394, 0.877757, 3.4879, 4.87145, 0.877757, 2.70793, 1.16996, -0.0966397, 4.26715, 6.04118, 0.682801, 3.87753, 2.33916, 0.877757, 2.90328, 6.04118, 0.098316, 4.07252, 0.975007, 0.487941, 4.46251)

[sub_resource type="ConvexPolygonShape3D" id="ConvexPolygonShape3D_7s0ye"]
points = PackedVector3Array(-0.0699724, 0.834024, -1.65764, -1.56866, 0.883776, -1.56809, -1.16912, -0.0966397, -2.35846, 0.0651841, 0.918497, -2.98335, -0.779518, -0.0966397, -2.7478, 0, 0.682801, -1.57892, -0.779518, 0.917503, -3.4042, -1.16912, -0.0966397, -2.7478, -0.779518, 0.487941, -1.57892, -0.194879, 0.682801, -3.33267, -1.21631, 0.936767, -2.78317, 0, 0.682801, -2.94264, -0.779518, -0.0966397, -2.35846, -1.60868, 0.908783, -1.73051, -1.55904, 0.682801, -1.57892, -0.584791, 0.293176, -1.77394, -0.779518, 0.682801, -3.33267, -0.994582, 0.929062, -3.20927, -0.194879, 0.877757, -3.33267, -0.779518, 0.293176, -1.77394, -0.389759, 0.487941, -1.57892)

[sub_resource type="ConvexPolygonShape3D" id="ConvexPolygonShape3D_8tf4o"]
points = PackedVector3Array(0.194879, 0.682801, -3.33267, 1.5687, 0.883797, -1.56805, 1.55904, 0.682801, -1.57892, 0, 0.682801, -1.57892, 1.16912, -0.0966397, -2.7478, 0.99459, 0.929083, -3.2093, 0.779518, -0.0966397, -2.35846, -0.065206, 0.918511, -2.98337, 0.06997, 0.834026, -1.65763, 0, 0.682801, -2.94264, 1.60873, 0.908815, -1.73047, 0.389759, 0.487941, -1.57892, 0.779518, 0.917524, -3.40424, 1.16912, -0.0966397, -2.35846, 0.779518, -0.0966397, -2.7478, 1.21634, 0.936807, -2.78319, 0.779518, 0.293176, -1.77394, 0.779518, 0.682801, -3.33267, 0.194879, 0.877757, -3.33267, 0.779518, 0.487941, -1.57892)

[sub_resource type="ConvexPolygonShape3D" id="ConvexPolygonShape3D_f1u6t"]
points = PackedVector3Array(0.779518, 0.682687, 4.65718, 0.389606, 1.07264, 5.43645, -0.19486, -0.0966396, 5.04707, 0.779518, -0.0966396, 0.955003, 0.801718, 0.487998, 0.674169, -0.389682, 1.07264, 4.26729, 0.779518, -0.0966396, 4.46249, -0.584638, -0.0966396, 4.46249, -0.19486, 0.877604, 6.02154, -0.619343, 0.283284, 0.625938, -0.584638, -0.0966396, 0.955003, -0.584638, 0.682687, 4.65718, 0.19465, 0.877604, 6.02154, 0.389606, 1.07264, 4.26729, 0.19465, 0.0982779, 5.43645, -0.19486, 1.07264, 6.02154, -0.19486, 0.0982779, 5.43645, -0.389682, 1.07264, 5.43645, 0.779518, 0.0982779, 4.65718, 0.584562, 0.487998, 0.7598, 0.19465, 1.07264, 6.02154, 0.779518, 0.682687, 3.87688, 0.19465, -0.0966396, 5.04707, -0.584638, 0.682687, 4.26729, -0.389682, 0.877604, 5.43645)

[sub_resource type="ConvexPolygonShape3D" id="ConvexPolygonShape3D_e1b8e"]
points = PackedVector3Array(-0.584638, 1.46243, 2.51383, 0.584638, 1.65722, 2.51383, 0.584638, 1.46243, 2.51383, 0.194803, 1.85215, 6.60618, 0.194803, 1.07279, 6.41103, -0.584638, 1.85215, 0.7598, 0.389606, 1.26765, 0.7598, 0.584638, 1.85215, 0.7598, -0.389606, 1.07279, 5.43645, -0.194803, 1.85215, 6.60618, -0.389606, 1.26765, 0.7598, 0.389606, 1.07279, 5.43645, -0.194803, 1.07279, 3.87699, -0.194803, 1.26765, 6.60618, -0.584638, 1.85215, 2.12468, 0.389606, 1.07279, 4.07214, 0.584638, 1.46243, 0.7598, -0.584638, 1.46243, 0.7598, -0.389606, 1.46243, 5.43645, 0.389606, 1.46243, 5.43645, 0.584638, 1.85215, 2.12468, -0.389606, 1.07279, 4.07214, -0.194803, 1.07279, 6.41103, 0.194803, 1.26765, 6.60618, 0.194803, 1.07279, 3.87699, -0.584638, 1.65722, 2.51383)

[node name="MegaPlane" type="Node3D" groups=["machines"]]
script = SubResource("GDScript_mvi26")

[node name="PilotPlane" type="Node3D" parent="."]
unique_name_in_owner = true
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0.663451, 0)
script = SubResource("GDScript_5ag8h")

[node name="Plane" type="RigidBody3D" parent="."]
unique_name_in_owner = true
mass = 50000.0
physics_material_override = SubResource("PhysicsMaterial_5ag8h")
linear_damp_mode = 1
linear_damp = 0.003

[node name="MeshInstance3D" type="MeshInstance3D" parent="Plane"]
material_override = SubResource("StandardMaterial3D_h10xb")
mesh = ExtResource("1_5ag8h")
skeleton = NodePath("../..")

[node name="CamHolder" type="Node3D" parent="Plane"]
unique_name_in_owner = true
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 1.56611, -4.07644)

[node name="CollisionShape3D" type="CollisionShape3D" parent="Plane"]
transform = Transform3D(0.942831, 0, 0, 0, 0.942831, 0, 0, 0, 0.942831, 0, 0, 0)
shape = SubResource("ConvexPolygonShape3D_5ag8h")

[node name="CollisionShape3D2" type="CollisionShape3D" parent="Plane"]
transform = Transform3D(0.984616, 0, 0, 0, 0.984616, 0, 0, 0, 0.984616, 0, 0, 0)
shape = SubResource("ConvexPolygonShape3D_phj5u")

[node name="CollisionShape3D3" type="CollisionShape3D" parent="Plane"]
transform = Transform3D(0.962137, 0, 0, 0, 0.962137, 0, 0, 0, 0.962137, 0, 0, 0)
shape = SubResource("ConvexPolygonShape3D_lofhx")

[node name="CollisionShape3D4" type="CollisionShape3D" parent="Plane"]
transform = Transform3D(0.977157, 0, 0, 0, 0.977157, 0, 0, 0, 0.977157, 0, 0, 0)
shape = SubResource("ConvexPolygonShape3D_3k2d7")

[node name="CollisionShape3D5" type="CollisionShape3D" parent="Plane"]
shape = SubResource("ConvexPolygonShape3D_7s0ye")

[node name="CollisionShape3D6" type="CollisionShape3D" parent="Plane"]
shape = SubResource("ConvexPolygonShape3D_8tf4o")

[node name="CollisionShape3D7" type="CollisionShape3D" parent="Plane"]
transform = Transform3D(0.945169, 0, 0, 0, 0.945169, 0, 0, 0, 0.945169, 0, 0, 0)
shape = SubResource("ConvexPolygonShape3D_f1u6t")

[node name="CollisionShape3D8" type="CollisionShape3D" parent="Plane"]
transform = Transform3D(0.99858, 0, 0, 0, 0.99858, 0, 0, 0, 0.99858, 0, 0, 0)
shape = SubResource("ConvexPolygonShape3D_e1b8e")
